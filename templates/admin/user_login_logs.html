{% extends "admin/admin_base.html" %}

{% block title %}Login Activity{% endblock %}
{% block page_title %}Login Activity{% endblock %}

{% block content %}

<div class="container-fluid px-4 py-3">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="fw-bold mb-0">Login Activity</h4>
      <small class="text-muted">
        Security audit trail for <strong>{{ user.email }}</strong>
      </small>
    </div>

    <a href="{{ url_for('admin.admin_users') }}"
       class="btn btn-sm btn-outline-secondary">
      ← Back to Users
    </a>
  </div>

  <!-- LOGIN TABLE CARD -->
  <div class="card shadow-sm">

    <!-- FILTER BAR -->
    <div class="card-header bg-white border-bottom">
      <form method="get" class="row g-2 align-items-center">

        <div class="col-md-4">
          <input class="form-control form-control-sm"
                 name="q"
                 value="{{ request.args.get('q','') }}"
                 placeholder="Search IP / Device / Status">
        </div>

        <div class="col-md-2">
          <select class="form-select form-select-sm" name="status">
            <option value="">All Status</option>
            <option value="success" {{ 'selected' if request.args.get('status')=='success' }}>Success</option>
            <option value="failed" {{ 'selected' if request.args.get('status')=='failed' }}>Failed</option>
            <option value="locked" {{ 'selected' if request.args.get('status')=='locked' }}>Locked</option>
            <option value="disabled" {{ 'selected' if request.args.get('status')=='disabled' }}>Disabled</option>
          </select>
        </div>

        <div class="col-md-2">
          <input type="date"
                 class="form-control form-control-sm"
                 name="to_date"
                 value="{{ request.args.get('to_date','') }}">
        </div>

<div class="col-md-3 d-flex gap-2">

  <!-- APPLY -->
  <button class="btn btn-primary btn-sm action-btn">
    <i class="bi bi-funnel me-1"></i> Apply
  </button>

  <!-- RESET -->
  <a href="{{ url_for('admin.user_login_history', user_id=user.id) }}"
     class="btn btn-outline-secondary btn-sm action-btn">
    <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
  </a>

  <!-- CSV EXPORT -->
  <a href="{{ url_for(
        'admin.export_user_login_history_csv',
        user_id=user.id,
        q=request.args.get('q'),
        status=request.args.get('status'),
        from_date=request.args.get('from_date'),
        to_date=request.args.get('to_date')
      ) }}"
     class="btn btn-outline-success btn-sm action-btn">
    <i class="bi bi-download me-1"></i> CSV
  </a>

</div>



        <!-- RESULTS COUNT -->
        <div class="col-md-12 mt-2">
          <small class="text-muted">
            Showing {{ pagination.total }} result{{ 's' if pagination.total != 1 }}
          </small>
        </div>

      </form>
    </div>

    <!-- TABLE -->
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light text-muted small">
          <tr>
            <th style="width:40px">ID</th>
            <th style="width:140px">Date</th>
            <th style="width:160px">Time</th>
            <th style="width:120px">IP Address</th>
            <th>Device</th>
            <th style="width:120px">Status</th>
          </tr>
        </thead>

        <tbody>

        {% if logs|length == 0 %}
          <!-- EMPTY STATE -->
          <tr>
            <td colspan="6" class="text-center text-muted py-4">
              No login activity found for selected filters
            </td>
          </tr>
        {% else %}

        {% for log in logs %}
          <tr class="
            {% if log.login_status == 'failed' %}table-danger{% endif %}
            {% if log.login_status == 'locked' %}table-warning{% endif %}
          ">

            <td>{{ loop.index }}</td>

            <!-- DATE -->
            <td class="fw-semibold">
  {{ log.created_at | format_ist("%d %b %Y") }}
</td>

            <!----TIME---->
<td class="text-muted small">
  {{ log.created_at | format_ist("%I:%M %p") }}
  <span class="ms-1">
    (
    <span class="timeago"
          data-time="{{ log.created_at | to_ist }}">
      just now
    </span>
    )
  </span>
</td>


            <!-- IP -->
            <td class="font-monospace small">
              {{ log.ip_address }}
            </td>

            <!-- DEVICE -->
            <td class="text-truncate small"
                style="max-width: 380px"
                title="{{ log.user_agent }}">
              {{ log.user_agent }}
            </td>

            <!-- STATUS -->
            <td>
              {% if log.login_status == 'success' %}
                <span class="badge bg-success-subtle text-success border">Success</span>
              {% elif log.login_status == 'failed' %}
                <span class="badge bg-danger-subtle text-danger border">Failed</span>
              {% elif log.login_status == 'locked' %}
                <span class="badge bg-dark-subtle text-dark border">Locked</span>
              {% elif log.login_status == 'disabled' %}
                <span class="badge bg-warning-subtle text-warning border">Disabled</span>
              {% else %}
                <span class="badge bg-secondary-subtle text-secondary border">
                  {{ log.login_status }}
                </span>
              {% endif %}
            </td>

          </tr>
        {% endfor %}
        {% endif %}

        </tbody>
      </table>

    </div>
<!-- PAGINATION -->
{% if pagination.pages > 1 %}
<div class="card-footer bg-white">
  <nav>
    <ul class="pagination pagination-sm mb-0 justify-content-end">

      <!-- PREVIOUS -->
      <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
        <a class="page-link"
           href="{{ url_for(
             'admin.user_login_history',
             user_id=user.id,
             page=pagination.prev_num,
             q=request.args.get('q'),
             status=request.args.get('status'),
             from_date=request.args.get('from_date'),
             to_date=request.args.get('to_date')
           ) }}">
          Previous
        </a>
      </li>

      <!-- PAGE NUMBERS -->
      {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
        {% if p %}
          <li class="page-item {% if p == pagination.page %}active{% endif %}">
            <a class="page-link"
               href="{{ url_for(
                 'admin.user_login_history',
                 user_id=user.id,
                 page=p,
                 q=request.args.get('q'),
                 status=request.args.get('status'),
                 from_date=request.args.get('from_date'),
                 to_date=request.args.get('to_date')
               ) }}">
              {{ p }}
            </a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">…</span>
          </li>
        {% endif %}
      {% endfor %}

      <!-- NEXT -->
      <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
        <a class="page-link"
           href="{{ url_for(
             'admin.user_login_history',
             user_id=user.id,
             page=pagination.next_num,
             q=request.args.get('q'),
             status=request.args.get('status'),
             from_date=request.args.get('from_date'),
             to_date=request.args.get('to_date')
           ) }}">
          Next
        </a>
      </li>

    </ul>
  </nav>
</div>
{% endif %}


  </div>
</div>

<!-- TIMEAGO SCRIPT -->
<script>
function timeAgo(dateString) {
  const now = new Date();
  const past = new Date(dateString);
  const diff = Math.floor((now - past) / 1000);

  if (diff < 60) return "just now";
  if (diff < 3600) return Math.floor(diff / 60) + " minutes ago";
  if (diff < 86400) return Math.floor(diff / 3600) + " hours ago";
  return Math.floor(diff / 86400) + " days ago";
}

function updateTimeago() {
  document.querySelectorAll(".timeago").forEach(el => {
    el.textContent = timeAgo(el.dataset.time);
  });
}

updateTimeago();
setInterval(updateTimeago, 60000);
</script>

<style>
.table tbody tr:hover {
  background-color: #f8f9fa;
}

  /* FILTER ACTION BUTTONS */
.action-btn {
  min-width: 92px;
  height: 36px;
  padding: 0 14px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 0.85rem;
  font-weight: 500;
  border-radius: 6px;
}

</style>

{% endblock %}
