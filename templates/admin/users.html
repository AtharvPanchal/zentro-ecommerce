{% extends "admin/admin_base.html" %}
{% block title %}User Management{% endblock %}
{% block page_title %}User Management{% endblock %}

{% block content %}

<div class="container-fluid px-4 py-3">

  <!-- PAGE HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="fw-bold mb-1">User Management</h4>
      <small class="text-muted">
        Manage user accounts, access levels and security controls
      </small>
    </div>

    <span class="badge bg-primary-subtle text-primary px-3 py-2 rounded-pill">
      {{ users|length }} Users
    </span>
  </div>

  <!-- USERS TABLE CARD -->
  <div class="card shadow-sm border-0">

    <!-- FILTER BAR -->
    <form method="get" class="row g-3 align-items-end mb-3 px-3 pt-3">

      <!-- SEARCH -->
      <div class="col-md-4">
        <label class="form-label small text-muted mb-1">Search</label>
        <input type="text"
               name="q"
               value="{{ request.args.get('q','') }}"
               class="form-control form-control-sm"
               placeholder="Email or User ID">
      </div>

      <!-- STATUS -->
      <div class="col-md-3">
        <label class="form-label small text-muted mb-1">Status</label>
        <select name="status" class="form-select form-select-sm">
          <option value="">All Status</option>
          <option value="active" {{ 'selected' if request.args.get('status')=='active' }}>Active</option>
          <option value="disabled" {{ 'selected' if request.args.get('status')=='disabled' }}>Disabled</option>
          <option value="locked" {{ 'selected' if request.args.get('status')=='locked' }}>Locked</option>
        </select>
      </div>

      <!-- ACTION BUTTONS -->
     <div class="col-md-3 d-flex gap-2">
  <button class="btn btn-primary btn-sm action-btn d-flex align-items-center justify-content-center gap-1">
     <i data-lucide="filter" class="icon"></i>
    <span>Apply</span>
  </button>

  <a href="{{ url_for('admin.admin_users') }}"
     class="btn btn-outline-secondary btn-sm action-btn d-flex align-items-center justify-content-center gap-1">
     <i data-lucide="rotate-ccw" class="icon"></i>
    <span>Reset</span>
  </a>
</div>


    </form>

    <!-- TABLE -->
    <div class="table-responsive">
      <table class="table align-middle mb-0 admin-users-table">

        <thead class="table-light text-muted small">
          <tr>
            <th style="width:70px">ID</th>
            <th>User</th>
            <th style="width:140px">Status</th>
            <th style="width:190px">Lock Until</th>
            <th style="width:340px" class="text-end">Actions</th>
          </tr>
        </thead>

        <tbody>

        {% if users|length == 0 %}
          <!-- EMPTY STATE -->
          <tr>
            <td colspan="5" class="text-center text-muted py-4">
              No users found for selected filters
            </td>
          </tr>
        {% endif %}

        {% for u in users %}
          <tr class="user-row">

            <!-- ID -->
            <td class="fw-semibold text-muted">{{ u.id }}</td>

            <!-- USER -->
            <td>
              <div class="d-flex align-items-center gap-3">
                <div class="user-avatar">
                  {{ u.email[0]|upper }}
                </div>
                <div>
                  <div class="fw-semibold">{{ u.email }}</div>
                  <div class="text-muted small">Registered user</div>
                </div>
              </div>
            </td>

            <!-- STATUS -->
<td>
  {% if u.lock_until %}

  <span class="status-pill danger">
    <span class="dot"></span> Locked
  </span>

  {% if u.status_reasons and u.status_reasons|length > 0 %}
  {% set last = u.status_reasons[-1] %}
  {% if last.action == "lock" %}
    <span class="badge bg-danger ms-2">Admin Lock</span>
  {% elif last.action in ["unlock", "disable", "enable"] %}
    <span class="badge bg-secondary ms-2">Admin Action</span>
  {% else %}
    <span class="badge bg-warning ms-2">Self Lock</span>
  {% endif %}
{% endif %}



  {% elif u.is_active %}
    <span class="status-pill success">
      <span class="dot"></span> Active
    </span>
  {% else %}
    <span class="status-pill warning">
      <span class="dot"></span> Disabled
    </span>
  {% endif %}

  {% if u.status_reasons and u.status_reasons|length > 0 and not u.lock_until %}
  {% set last = u.status_reasons[-1] %}
  <div class="text-muted small mt-1">
    {{ last.action|capitalize }} – {{ last.reason }}
  </div>
{% endif %}

</td>

            <!-- LOCK UNTIL -->
            <td class="text-muted small">
              {% if u.lock_until %}
              {{ (u.lock_until|to_ist).strftime('%d %b %Y, %I:%M %p') }}

              {% else %}
                —
              {% endif %}
            </td>

            <!-- ACTIONS -->
         <td class="text-end">
  <div class="d-inline-flex gap-2 align-items-center">

    {% if u.lock_until %}
  <!-- UNLOCK & ENABLE -->
  <form method="POST" action="{{ url_for('admin.unlock_user', user_id=u.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button class="btn btn-sm btn-outline-success action-btn">
      <i data-lucide="unlock" class="icon"></i>
      <span>Unlock & Enable</span>
    </button>
  </form>

  <!-- UNLOCK ONLY (KEEP DISABLED) -->
  <form method="POST" action="{{ url_for('admin.unlock_user', user_id=u.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="keep_disabled" value="1">
    <button class="btn btn-sm btn-outline-secondary action-btn">
      <i data-lucide="unlock" class="icon"></i>
      <span>Unlock only</span>
    </button>
  </form>

    {% else %}
      <!-- ENABLE / DISABLE -->
      <form method="POST" action="{{ url_for('admin.toggle_user_status', user_id=u.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% if u.is_active %}
          <button class="btn btn-sm btn-outline-warning action-btn">
            <i data-lucide="user-x" class="icon"></i>
            <span>Disable</span>
          </button>
        {% else %}
          <button class="btn btn-sm btn-outline-success action-btn">
            <i data-lucide="user-check" class="icon"></i>
            <span>Enable</span>
          </button>
        {% endif %}
      </form>

      <!-- LOCK -->
      {% if u.is_active %}
        <form method="POST" action="{{ url_for('admin.lock_user', user_id=u.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn btn-sm btn-outline-danger action-btn">
            <i data-lucide="lock" class="icon"></i>
            <span>Lock</span>
          </button>
        </form>
      {% endif %}
    {% endif %}

    <!-- LOGS (ALWAYS VISIBLE) -->
    <a href="{{ url_for('admin.user_login_history', user_id=u.id) }}"
       class="btn btn-sm btn-primary action-btn">
      <i data-lucide="activity" class="icon"></i>
      <span>Logs</span>
    </a>

  </div>
</td>

          </tr>
        {% endfor %}

        </tbody>
      </table>
    </div>

  </div>
</div>

<style>
/* ===============================
   ENTERPRISE USER MANAGEMENT UI
   =============================== */

.admin-users-table thead th {
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-size: 0.7rem;
}

.user-row {
  transition: background 0.15s ease;
}

.user-row:hover {
  background: #f9fafb;
}

.user-avatar {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  background: #e7edff;
  color: #3b5bdb;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
}

/* STATUS PILL */
.status-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: 999px;
}

.status-pill .dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
}

.status-pill.success {
  background: #e6f4ea;
  color: #1e7e34;
}
.status-pill.success .dot { background: #1e7e34; }

.status-pill.warning {
  background: #fff3cd;
  color: #856404;
}
.status-pill.warning .dot { background: #856404; }

.status-pill.danger {
  background: #fdecea;
  color: #b02a37;
}
.status-pill.danger .dot { background: #b02a37; }

.icon {
  width: 16px;
  height: 16px;
  stroke-width: 1.8;
}

.action-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  height: 36px;
  padding: 0 14px;
  font-size: 0.78rem;
  font-weight: 500;
  border-radius: 6px;
}


</style>

{% endblock %}
